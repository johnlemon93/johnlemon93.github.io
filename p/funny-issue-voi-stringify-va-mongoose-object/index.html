<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="content-type" content="text/html"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"><!-- <link href="/emoji/css/messenger.min.css" rel="stylesheet"> --><meta name="google-site-verification" content="pETm_1ofxmKp-snT-jxtmVt2uUhH3F13ZofnfafrW9w"><title>Funny issue với JSON.stringify và Mongoose object | Chanh's blog</title><link rel="stylesheet" href="/index.bd.css" type="text/css"><script defer="defer" src="/index.bd.js"></script></head><body><div itemscope itemtype="https://schema.org/Blog" id="root"><header class="header2"><a class="head" href="/"><span class="avatar"></span> <span class="header-link">Chanh's Blog</span> </a><a class="subscribe" href="/" rel="noopener noreferrer" target="blank">Follow me</a></header><main id="container"><article itemscope itemtype="https://schema.org/BlogPosting" class="post-container"><section class="content"><h1 itemprop="name headline" id="funny-issue-với-jsonstringify-và-mongoose-object">Funny issue với JSON.stringify và Mongoose object</h1><p></p><div class="published" itemprop="datePublished"><b>Published:</b> 2018-10-28 19:19:18</div><p></p><p><img src="/p/funny-issue-voi-stringify-va-mongoose-object/img/intro.png" alt="Intro pic!" title="Intro pic!"></p><p>Thật ra <code>Mongooose object</code> cũng có lúc cầm bó hoa, nhưng phần lớn thời gian hắn chỉ cầm cục gạch thôi. Cho nên cũng không phải là không may mà thằng cu H team tôi mới bị phang gạch vào đầu.</p><h2 id="mở-đầu">Mở đầu</h2><p>Tôi, một thằng mới chuyển từ .NET sang NodeJS, đang bù đầu với cái bug thì thằng cu trong team vác mặt qua nhờ:</p><ul><li>&quot;Anh ơi xem giúp em với, sao data debug trên server với data trả về ở client lại khác nhau thế này?!&quot;</li></ul><h3 id="object-result-debug-trên-server-trước-khi-gọi-resjsonresult">object <code>result</code> debug trên server trước khi gọi <code>res.json(result)</code></h3><pre><code class="hljs lang-json"><span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;121qwdas151asd123&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;The coffee house&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Tran Phu, Hai Chau, Da Nang&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0905246357&quot;</span><span class="hljs-punctuation">,</span>
        ...
        <span class="hljs-attr">&quot;views&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;55&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;likes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;90&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;comments&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;22&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;conversionRate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.4&quot;</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre><h3 id="data-trả-về-dưới-webview-sau-khi-gửi-get-request">data trả về dưới webview sau khi gửi <code>get</code> request</h3><pre><code class="hljs lang-json"><span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
        ...
        <span class="hljs-attr">&quot;views&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;55&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;likes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;90&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;comments&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;22&quot;</span>
        ??? <span class="hljs-number">404</span> conversionRate mất tiêu
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre><p>Sau 30s debug bên Node tôi quở nó:</p><ul><li>&quot;Mày coi lại bên webview có filter hay xử lý data sai chỗ nào không?&quot;</li></ul><h2 id="nửa-tiếng-sau">Nửa tiếng sau</h2><p>Xong task rồi quay qua thấy nó vẫn làm mặt 😢 thiểu não.</p><ul><li>&quot;Chưa ra luôn hả cu. Thôi xê ra để anh coi cho!!&quot;.</li></ul><h3 id="đầu-tiên-tôi-bật-postman-lên-test-xem-bên-service-trả-về-đúng-không">Đầu tiên tôi bật Postman lên, test xem bên service trả về đúng không.</h3><p>Ủa vẫn miss cái field nó cần.</p><pre><code class="hljs lang-js">[
    {
        ...
        ??? <span class="hljs-number">404</span> conversionRate vẫn mất tiêu
    }
]
</code></pre><h3 id="ok-sorry-thằng-em-code-bên-node-của-mày-có-vấn-đề">OK sorry thằng em, code bên Node của mày có vấn đề</h3><pre><code class="hljs lang-js">route.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/providers/:category&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> category = req.<span class="hljs-property">params</span>.<span class="hljs-property">category</span>;
    <span class="hljs-title class_">ProviderService</span>.<span class="hljs-title function_">getProvidersByCategory</span>(category)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">calculateConversionRate</span>(result.<span class="hljs-property">data</span>);
            res.<span class="hljs-title function_">json</span>(data);
        });
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateCoversionRate</span>(<span class="hljs-params">providers</span>) {
    providers.<span class="hljs-title function_">foreach</span>(<span class="hljs-function"><span class="hljs-params">provider</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> {visits, views, comments} = provider;
        provider.<span class="hljs-property">conversionRate</span> = 
            visits / (views + comments) * <span class="hljs-title class_">Constants</span>.<span class="hljs-property">factor</span>;
    });

    <span class="hljs-keyword">return</span> providers;
}
</code></pre><p>Ủa có vấn đề gì đâu ta?? Tôi bắt đầu thử:</p><ol><li>Copy content của <code>data</code> ra một biến string, rồi <code>res.json()</code>. Chạy đúng, OK vậy chả có ký tự gì đặc biệt đến nỗi không serialize được.</li><li>Nhìn mãi chả biết lỗi ở đâu. Tôi đổi tên <code>conversionRate</code> thành <code>stupidRate</code>. Failed!</li><li>Sau 5 phút suy nghĩ, thay vì add field mới, tôi update field <code>phone</code> của object thành giá trị của <code>conversionRate</code> rồi gọi <code>res.json()</code>. Thấy trên Postman lẫn browser đều có giá trị đó trong field <code>phone</code> 😵.</li></ol><p>Ngẫm nghĩ một hồi... Từ lúc query database đến chỗ <code>res.json()</code> thì mọi thứ vẫn đúng. Tôi dừng debug, tìm official doc của <strong>Express</strong> đọc.</p><blockquote><h3 id="resjsonbody">res.json([body])</h3><p>Sends a JSON response. This method sends a response (with the correct content-type) that is the parameter converted to a JSON string using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify()</a>.</p></blockquote><h3 id="ok-ta-đã-có-manh-mối-mới-jsonstringify">Ok ta đã có manh mối mới: <code>JSON.stringify()</code></h3><p>Tôi thử lại 3 cases trên với hàm <code>JSON.stringify()</code>. Kết quả vẫn thế.</p><p>Hmm, lên đọc doc của nó thôi 😣.</p><blockquote><p><code>JSON.stringify()</code> converts a value to JSON notation representing it:</p><ul><li>If the value has a <code>toJSON()</code> method, it&#39;s responsible to define what data will be serialized.</li></ul></blockquote><p>À THÔI ĐÚNG RỒI! Chính nó. Mà khoan, không nên mừng vội, thử phát.</p><p><img src="/p/funny-issue-voi-stringify-va-mongoose-object/img/toJSON-spot.png" alt="toJSON spot!" title="toJSON spot!"></p><h2 id="giờ-mừng-được-rồi">Giờ mừng được rồi!</h2><p>Vậy sau gần tiếng rưỡi mò mẫm ngu người do không chịu coi docs sớm, thủ phạm đã lòi đuôi.</p><p>Thằng cu H nó return thẳng object của Mongoose 😫. Nên khi serialize để trả về client:</p><ul><li><code>res.json()</code> convert object thành chuỗi JSON đó bằng <code>JSON.stringify()</code></li><li>Thằng stringify thấy object đó của Mongoose có define hàm <code>toJSON()</code></li><li>Có vẻ hàm <code>toJSON()</code> của Mongoose chỉ trả về những field đã define lúc tạo model bằng <code>mongoose.Schema</code>.</li><li>Nên có debug với thử trời đi nữa thì cái field <code>conversionRate</code> vẫn mất tiêu.</li></ul><p>OK! Thằng cu H ăn nguyên cục gạch như vậy đấy.</p><h2 id="giải-pháp">Giải pháp</h2><p>Best practice là chỉ trả về những thứ mà client cần thôi. Không phải tự nhiên mà người ta khuyên nên dùng <strong>dto</strong> tức <em>data transfer object</em>.</p><pre><code class="hljs lang-js">    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderDTO</span> {
        <span class="hljs-title function_">constructor</span>(<span class="hljs-params">provider</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = provider.<span class="hljs-property">_id_</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = provider.<span class="hljs-property">name</span>;
            <span class="hljs-comment">// ...</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversionRate</span> = <span class="hljs-title function_">calculateConversionRate</span>(provider);
        }
    }

    route.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/providers/:category&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> category = req.<span class="hljs-property">params</span>.<span class="hljs-property">category</span>;
        <span class="hljs-title class_">ProviderService</span>.<span class="hljs-title function_">getProvidersByCategory</span>(category)
            .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
                <span class="hljs-keyword">const</span> data = result.<span class="hljs-property">data</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">provider</span> =&gt;</span>
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderDTO</span>(provider));
                res.<span class="hljs-title function_">json</span>(data);
            });
    });
</code></pre><h2 id="lời-kết">Lời kết</h2><p>Bài học rút ra:</p><ul><li>Follow best practices sẽ giúp ta tránh những lỗi ngớ ngẩn trên.</li><li>Nên đọc docs và hiểu bản chất vấn đề trước khi bay vào debug và thử này kia một cách bâng quơ như tui.</li><li>Javascript si đa thật, nhưng không liên quan gì đến issue này.</li></ul><p>Thằng cu H trả lại a hơn tiếng rưỡi cuộc đời mau 😤!</p><p>p/s: Thêm 1 tiếng đồng hồ ngồi viết bài này nữa.</p></section><section class="copyright">Có lòng thì cho mình xin ít like rồi thích share hay post lại gì cũng được. <strong>Cơ mà</strong> phải <strong>ghi rõ nguồn, tác giả và không làm thay đổi nội dung bài viết</strong>. "Ứ làm theo đấy rồi sao!". Ờ thì cũng được thôi, sau này trên đường đời tấp nập, nhỡ có va vào nhau thì cho mình nện cục gạch!!! <i id="brick"></i> Chào thân ái và quyết thắng!</section><section class="likebox"><iframe class="fb-like" src="https://www.facebook.com/plugins/like.php?href=https%3A%2F%2Fblogchanhday.com%2Fp%2Ffunny-issue-voi-stringify-va-mongoose-object%2Findex.html&layout=standard&action=like&size=small&show_faces=true&share=true&colorscheme=light&appId=1451967558408105" title="Facebook like box" height="56" width="450" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe></section><link rel="stylesheet" href="/comment.bd.css" type="text/css"><script defer="defer" src="/comment.bd.js"></script><section class="comments"></section><button onclick="" id="go-top" title="Go to top"><i class="icon-up-open"></i></button></article></main><footer><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a><p>Created with <a href="https://github.com/johnlemon93/blog-page-ssr">Blog Page SSR</a></p><div class="social"><a target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/blogchanhday"><i class="icon-facebook-squared"></i></a> <a target="_blank" rel="noopener noreferrer" href="https://github.com/johnlemon93"><i class="icon-github-squared"></i></a> <a target="_blank" rel="noopener noreferrer" href="https://blogchanhday.com"><i class="icon-emo-coffee"></i></a></div></footer></div></body></html>