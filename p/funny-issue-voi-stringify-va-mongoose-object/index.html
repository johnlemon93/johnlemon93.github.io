<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="content-type" content="text/html"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"><!-- <link href="/emoji/css/messenger.min.css" rel="stylesheet"> --><meta name="google-site-verification" content="pETm_1ofxmKp-snT-jxtmVt2uUhH3F13ZofnfafrW9w"><title>Funny issue vá»›i JSON.stringify vÃ  Mongoose object | Chanh's blog</title><link rel="stylesheet" href="/index.bd.css" type="text/css"><script defer="defer" src="/index.bd.js"></script></head><body><div itemscope itemtype="https://schema.org/Blog" id="root"><header class="header2"><a class="head" href="/"><span class="avatar"></span> <span class="header-link">Chanh's Blog</span> </a><a class="subscribe" href="/" rel="noopener noreferrer" target="blank">Follow me</a></header><main id="container"><article itemscope itemtype="https://schema.org/BlogPosting" class="post-container"><section class="content"><h1 itemprop="name headline" id="funny-issue-vá»›i-jsonstringify-vÃ -mongoose-object">Funny issue vá»›i JSON.stringify vÃ  Mongoose object</h1><p></p><div class="published" itemprop="datePublished"><b>Published:</b> 2018-10-28 19:19:18</div><p></p><p><img src="/p/funny-issue-voi-stringify-va-mongoose-object/img/intro.png" alt="Intro pic!" title="Intro pic!"></p><p>Tháº­t ra <code>Mongooose object</code> cÅ©ng cÃ³ lÃºc cáº§m bÃ³ hoa, nhÆ°ng pháº§n lá»›n thá»i gian háº¯n chá»‰ cáº§m cá»¥c gáº¡ch thÃ´i. Cho nÃªn cÅ©ng khÃ´ng pháº£i lÃ  khÃ´ng may mÃ  tháº±ng cu H team tÃ´i má»›i bá»‹ phang gáº¡ch vÃ o Ä‘áº§u.</p><h2 id="má»Ÿ-Ä‘áº§u">Má»Ÿ Ä‘áº§u</h2><p>TÃ´i, má»™t tháº±ng má»›i chuyá»ƒn tá»« .NET sang NodeJS, Ä‘ang bÃ¹ Ä‘áº§u vá»›i cÃ¡i bug thÃ¬ tháº±ng cu trong team vÃ¡c máº·t qua nhá»:</p><ul><li>&quot;Anh Æ¡i xem giÃºp em vá»›i, sao data debug trÃªn server vá»›i data tráº£ vá» á»Ÿ client láº¡i khÃ¡c nhau tháº¿ nÃ y?!&quot;</li></ul><h3 id="object-result-debug-trÃªn-server-trÆ°á»›c-khi-gá»i-resjsonresult">object <code>result</code> debug trÃªn server trÆ°á»›c khi gá»i <code>res.json(result)</code></h3><pre><code class="hljs lang-json"><span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;121qwdas151asd123&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;The coffee house&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Tran Phu, Hai Chau, Da Nang&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;phone&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0905246357&quot;</span><span class="hljs-punctuation">,</span>
        ...
        <span class="hljs-attr">&quot;views&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;55&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;likes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;90&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;comments&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;22&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;conversionRate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.4&quot;</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre><h3 id="data-tráº£-vá»-dÆ°á»›i-webview-sau-khi-gá»­i-get-request">data tráº£ vá» dÆ°á»›i webview sau khi gá»­i <code>get</code> request</h3><pre><code class="hljs lang-json"><span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
        ...
        <span class="hljs-attr">&quot;views&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;55&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;likes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;90&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;comments&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;22&quot;</span>
        ??? <span class="hljs-number">404</span> conversionRate máº¥t tiÃªu
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre><p>Sau 30s debug bÃªn Node tÃ´i quá»Ÿ nÃ³:</p><ul><li>&quot;MÃ y coi láº¡i bÃªn webview cÃ³ filter hay xá»­ lÃ½ data sai chá»— nÃ o khÃ´ng?&quot;</li></ul><h2 id="ná»­a-tiáº¿ng-sau">Ná»­a tiáº¿ng sau</h2><p>Xong task rá»“i quay qua tháº¥y nÃ³ váº«n lÃ m máº·t ğŸ˜¢ thiá»ƒu nÃ£o.</p><ul><li>&quot;ChÆ°a ra luÃ´n háº£ cu. ThÃ´i xÃª ra Ä‘á»ƒ anh coi cho!!&quot;.</li></ul><h3 id="Ä‘áº§u-tiÃªn-tÃ´i-báº­t-postman-lÃªn-test-xem-bÃªn-service-tráº£-vá»-Ä‘Ãºng-khÃ´ng">Äáº§u tiÃªn tÃ´i báº­t Postman lÃªn, test xem bÃªn service tráº£ vá» Ä‘Ãºng khÃ´ng.</h3><p>á»¦a váº«n miss cÃ¡i field nÃ³ cáº§n.</p><pre><code class="hljs lang-js">[
    {
        ...
        ??? <span class="hljs-number">404</span> conversionRate váº«n máº¥t tiÃªu
    }
]
</code></pre><h3 id="ok-sorry-tháº±ng-em-code-bÃªn-node-cá»§a-mÃ y-cÃ³-váº¥n-Ä‘á»">OK sorry tháº±ng em, code bÃªn Node cá»§a mÃ y cÃ³ váº¥n Ä‘á»</h3><pre><code class="hljs lang-js">route.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/providers/:category&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> category = req.<span class="hljs-property">params</span>.<span class="hljs-property">category</span>;
    <span class="hljs-title class_">ProviderService</span>.<span class="hljs-title function_">getProvidersByCategory</span>(category)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">calculateConversionRate</span>(result.<span class="hljs-property">data</span>);
            res.<span class="hljs-title function_">json</span>(data);
        });
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateCoversionRate</span>(<span class="hljs-params">providers</span>) {
    providers.<span class="hljs-title function_">foreach</span>(<span class="hljs-function"><span class="hljs-params">provider</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> {visits, views, comments} = provider;
        provider.<span class="hljs-property">conversionRate</span> = 
            visits / (views + comments) * <span class="hljs-title class_">Constants</span>.<span class="hljs-property">factor</span>;
    });

    <span class="hljs-keyword">return</span> providers;
}
</code></pre><p>á»¦a cÃ³ váº¥n Ä‘á» gÃ¬ Ä‘Ã¢u ta?? TÃ´i báº¯t Ä‘áº§u thá»­:</p><ol><li>Copy content cá»§a <code>data</code> ra má»™t biáº¿n string, rá»“i <code>res.json()</code>. Cháº¡y Ä‘Ãºng, OK váº­y cháº£ cÃ³ kÃ½ tá»± gÃ¬ Ä‘áº·c biá»‡t Ä‘áº¿n ná»—i khÃ´ng serialize Ä‘Æ°á»£c.</li><li>NhÃ¬n mÃ£i cháº£ biáº¿t lá»—i á»Ÿ Ä‘Ã¢u. TÃ´i Ä‘á»•i tÃªn <code>conversionRate</code> thÃ nh <code>stupidRate</code>. Failed!</li><li>Sau 5 phÃºt suy nghÄ©, thay vÃ¬ add field má»›i, tÃ´i update field <code>phone</code> cá»§a object thÃ nh giÃ¡ trá»‹ cá»§a <code>conversionRate</code> rá»“i gá»i <code>res.json()</code>. Tháº¥y trÃªn Postman láº«n browser Ä‘á»u cÃ³ giÃ¡ trá»‹ Ä‘Ã³ trong field <code>phone</code> ğŸ˜µ.</li></ol><p>Ngáº«m nghÄ© má»™t há»“i... Tá»« lÃºc query database Ä‘áº¿n chá»— <code>res.json()</code> thÃ¬ má»i thá»© váº«n Ä‘Ãºng. TÃ´i dá»«ng debug, tÃ¬m official doc cá»§a <strong>Express</strong> Ä‘á»c.</p><blockquote><h3 id="resjsonbody">res.json([body])</h3><p>Sends a JSON response. This method sends a response (with the correct content-type) that is the parameter converted to a JSON string using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">JSON.stringify()</a>.</p></blockquote><h3 id="ok-ta-Ä‘Ã£-cÃ³-manh-má»‘i-má»›i-jsonstringify">Ok ta Ä‘Ã£ cÃ³ manh má»‘i má»›i: <code>JSON.stringify()</code></h3><p>TÃ´i thá»­ láº¡i 3 cases trÃªn vá»›i hÃ m <code>JSON.stringify()</code>. Káº¿t quáº£ váº«n tháº¿.</p><p>Hmm, lÃªn Ä‘á»c doc cá»§a nÃ³ thÃ´i ğŸ˜£.</p><blockquote><p><code>JSON.stringify()</code> converts a value to JSON notation representing it:</p><ul><li>If the value has a <code>toJSON()</code> method, it&#39;s responsible to define what data will be serialized.</li></ul></blockquote><p>Ã€ THÃ”I ÄÃšNG Rá»’I! ChÃ­nh nÃ³. MÃ  khoan, khÃ´ng nÃªn má»«ng vá»™i, thá»­ phÃ¡t.</p><p><img src="/p/funny-issue-voi-stringify-va-mongoose-object/img/toJSON-spot.png" alt="toJSON spot!" title="toJSON spot!"></p><h2 id="giá»-má»«ng-Ä‘Æ°á»£c-rá»“i">Giá» má»«ng Ä‘Æ°á»£c rá»“i!</h2><p>Váº­y sau gáº§n tiáº¿ng rÆ°á»¡i mÃ² máº«m ngu ngÆ°á»i do khÃ´ng chá»‹u coi docs sá»›m, thá»§ pháº¡m Ä‘Ã£ lÃ²i Ä‘uÃ´i.</p><p>Tháº±ng cu H nÃ³ return tháº³ng object cá»§a Mongoose ğŸ˜«. NÃªn khi serialize Ä‘á»ƒ tráº£ vá» client:</p><ul><li><code>res.json()</code> convert object thÃ nh chuá»—i JSON Ä‘Ã³ báº±ng <code>JSON.stringify()</code></li><li>Tháº±ng stringify tháº¥y object Ä‘Ã³ cá»§a Mongoose cÃ³ define hÃ m <code>toJSON()</code></li><li>CÃ³ váº» hÃ m <code>toJSON()</code> cá»§a Mongoose chá»‰ tráº£ vá» nhá»¯ng field Ä‘Ã£ define lÃºc táº¡o model báº±ng <code>mongoose.Schema</code>.</li><li>NÃªn cÃ³ debug vá»›i thá»­ trá»i Ä‘i ná»¯a thÃ¬ cÃ¡i field <code>conversionRate</code> váº«n máº¥t tiÃªu.</li></ul><p>OK! Tháº±ng cu H Äƒn nguyÃªn cá»¥c gáº¡ch nhÆ° váº­y Ä‘áº¥y.</p><h2 id="giáº£i-phÃ¡p">Giáº£i phÃ¡p</h2><p>Best practice lÃ  chá»‰ tráº£ vá» nhá»¯ng thá»© mÃ  client cáº§n thÃ´i. KhÃ´ng pháº£i tá»± nhiÃªn mÃ  ngÆ°á»i ta khuyÃªn nÃªn dÃ¹ng <strong>dto</strong> tá»©c <em>data transfer object</em>.</p><pre><code class="hljs lang-js">    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderDTO</span> {
        <span class="hljs-title function_">constructor</span>(<span class="hljs-params">provider</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = provider.<span class="hljs-property">_id_</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = provider.<span class="hljs-property">name</span>;
            <span class="hljs-comment">// ...</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversionRate</span> = <span class="hljs-title function_">calculateConversionRate</span>(provider);
        }
    }

    route.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/providers/:category&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> category = req.<span class="hljs-property">params</span>.<span class="hljs-property">category</span>;
        <span class="hljs-title class_">ProviderService</span>.<span class="hljs-title function_">getProvidersByCategory</span>(category)
            .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
                <span class="hljs-keyword">const</span> data = result.<span class="hljs-property">data</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">provider</span> =&gt;</span>
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderDTO</span>(provider));
                res.<span class="hljs-title function_">json</span>(data);
            });
    });
</code></pre><h2 id="lá»i-káº¿t">Lá»i káº¿t</h2><p>BÃ i há»c rÃºt ra:</p><ul><li>Follow best practices sáº½ giÃºp ta trÃ¡nh nhá»¯ng lá»—i ngá»› ngáº©n trÃªn.</li><li>NÃªn Ä‘á»c docs vÃ  hiá»ƒu báº£n cháº¥t váº¥n Ä‘á» trÆ°á»›c khi bay vÃ o debug vÃ  thá»­ nÃ y kia má»™t cÃ¡ch bÃ¢ng quÆ¡ nhÆ° tui.</li><li>Javascript si Ä‘a tháº­t, nhÆ°ng khÃ´ng liÃªn quan gÃ¬ Ä‘áº¿n issue nÃ y.</li></ul><p>Tháº±ng cu H tráº£ láº¡i a hÆ¡n tiáº¿ng rÆ°á»¡i cuá»™c Ä‘á»i mau ğŸ˜¤!</p><p>p/s: ThÃªm 1 tiáº¿ng Ä‘á»“ng há»“ ngá»“i viáº¿t bÃ i nÃ y ná»¯a.</p></section><section class="copyright">CÃ³ lÃ²ng thÃ¬ cho mÃ¬nh xin Ã­t like rá»“i thÃ­ch share hay post láº¡i gÃ¬ cÅ©ng Ä‘Æ°á»£c. <strong>CÆ¡ mÃ </strong> pháº£i <strong>ghi rÃµ nguá»“n, tÃ¡c giáº£ vÃ  khÃ´ng lÃ m thay Ä‘á»•i ná»™i dung bÃ i viáº¿t</strong>. "á»¨ lÃ m theo Ä‘áº¥y rá»“i sao!". á»œ thÃ¬ cÅ©ng Ä‘Æ°á»£c thÃ´i, sau nÃ y trÃªn Ä‘Æ°á»ng Ä‘á»i táº¥p náº­p, nhá»¡ cÃ³ va vÃ o nhau thÃ¬ cho mÃ¬nh ná»‡n cá»¥c gáº¡ch!!! <i id="brick"></i> ChÃ o thÃ¢n Ã¡i vÃ  quyáº¿t tháº¯ng!</section><section class="likebox"><iframe class="fb-like" src="https://www.facebook.com/plugins/like.php?href=https%3A%2F%2Fblogchanhday.com%2Fp%2Ffunny-issue-voi-stringify-va-mongoose-object%2Findex.html&layout=standard&action=like&size=small&show_faces=true&share=true&colorscheme=light&appId=1451967558408105" title="Facebook like box" height="56" width="450" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe></section><link rel="stylesheet" href="/comment.bd.css" type="text/css"><script defer="defer" src="/comment.bd.js"></script><section class="comments"></section><button onclick="" id="go-top" title="Go to top"><i class="icon-up-open"></i></button></article></main><footer><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a><p>Created with <a href="https://github.com/johnlemon93/blog-page-ssr">Blog Page SSR</a></p><div class="social"><a target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/blogchanhday"><i class="icon-facebook-squared"></i></a> <a target="_blank" rel="noopener noreferrer" href="https://github.com/johnlemon93"><i class="icon-github-squared"></i></a> <a target="_blank" rel="noopener noreferrer" href="https://blogchanhday.com"><i class="icon-emo-coffee"></i></a></div></footer></div></body></html>