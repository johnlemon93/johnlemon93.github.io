<!DOCTYPE html><html><head><title>JavaScript: Tá»•ng quan vá» engine, event loop, callback queue... | Chanh's blog</title><meta charset="utf-8"><meta http-equiv="content-type" content="text/html"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese" rel="stylesheet"><meta name="google-site-verification" content="pETm_1ofxmKp-snT-jxtmVt2uUhH3F13ZofnfafrW9w"/><script type="text/javascript"></script><link href="/static/css/main.92b9ef6d.css" rel="stylesheet"></head><body><div itemscope itemtype="https://schema.org/Blog" id="root"><header class="header2"><a class="head" href="/"><span class="avatar"></span><span class="header-link">Chanh&#x27;s Blog</span></a><a class="subscribe" href="/" rel="noopener noreferrer" target="blank">Follow me</a></header><main id="container"><article itemscope="" itemType="https://schema.org/BlogPosting" class="post-container"><section class="content"><h1 itemprop="name headline" id="javascript-t-ng-quan-v-engine-runtime-call-stack-single-threaded-concurrency-event-loop-">JavaScript: Tá»•ng quan vá» engine, runtime, call stack, single-threaded, concurrency, event loop...</h1>
<p><div class="published" itemprop="datePublished"><b>Published:</b> 2018-09-19 11:20:20</div></p>

<p><strong>TL;DR:</strong> Náº¿u báº¡n ngáº¡i Ä‘á»c vÃ¬ nÃ³ quÃ¡ dÃ i nhÆ°ng khÃ´ng ngáº¡i nghe Eng thÃ¬ hÃ£y xem video nÃ y. BÃ i viáº¿t cá»§a mÃ¬nh khÃ´ng gÃ¬ hÆ¡n ngoÃ i tá»•ng há»£p vÃ  giáº£i thÃ­ch nhá»¯ng gÃ¬ anh Philip Roberts Ä‘Ã£ trÃ¬nh bÃ y.</p>
<iframe class="center" width="700" height="394" src="https://www.youtube.com/embed/8aGhZQkoFbQ" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>

<p>Nay nhÃ  nhÃ  ngÆ°á»i ngÆ°á»i há»c JavaScript (JS). Tá»« front-end, back-end, mobile hay Ä‘áº¿n cáº£ IoT vÃ¢n vÃ¢n, ta Ä‘á»u cÃ³ thá»ƒ báº¯t gáº·p JS.</p>
<p>NhÆ°ng cÃ³ lÃºc nÃ o Ä‘Ã³, giá»¯a nhá»¯ng má»› há»—n Ä‘á»™n framework, tooling, bundler hay webpack, báº¡n cÃ³ dá»«ng láº¡i má»™t chÃºt vÃ  tá»± há»i Javascript hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?</p>
<p>Náº¿u cÃ³ thÃ¬ xin chÃºc má»«ng! VÃ¬ má»™t khi quy mÃ´ project JS ngÃ y cÃ ng lá»›n hÆ¡n, báº¡n cáº§n pháº£i táº­n dá»¥ng má»i thá»© tá»« ngÃ´n ngá»¯ vÃ  há»‡ sinh thÃ¡i vá»›i sá»± tháº¥u hiá»ƒu sÃ¢u sáº¯c vá» cáº¥u trÃºc, cÃ¡ch váº­n hÃ nh bÃªn trong... Ä‘á»ƒ cÃ³ thá»ƒ tá»‘i Æ°u sáº£n pháº©m cá»§a mÃ¬nh má»™t cÃ¡ch tá»‘t nháº¥t.</p>
<p>Äiá»u Ä‘Ã³ quyáº¿t Ä‘á»‹nh vá»‹ trÃ­ cá»§a báº¡n trong ngÃ nh pháº§n má»m khá»‘c liá»‡t nÃ y, vá»›i tÆ° cÃ¡ch lÃ  má»™t developer hay chá»‰ lÃ  coder.</p>
<h2 id="t-ng-quan">Tá»•ng quan</h2>
<blockquote>
<p>TÃ´i lÃ  má»™t ngÃ´n ngá»¯ <strong>single-threaded</strong>, <strong>non-blocking</strong>, <strong>asynchronous</strong> vÃ  <strong>concurrent</strong>. TÃ´i cÃ³ má»™t cÃ¡i <strong>call stack</strong>, má»™t <strong>event loop</strong>, má»™t <strong>callback queue</strong>, vÃ i <strong>apis</strong> vÃ  cÃ¡c thá»© linh tinh khÃ¡c.</p>
<p>-- JavaScript</p>
</blockquote>
<p>Okay, chÃºng ta sáº½ cÃ¹ng láº§n lÆ°á»£t tÃ¬m hiá»ƒu chi tiáº¿t cÃ¡c concept áº¥y vÃ  cÃ¡ch mÃ  JS hoáº¡t Ä‘á»™ng.</p>
<p>Náº¿u báº¡n Ä‘Æ¡n giáº£n chá»‰ tÃ² mÃ² vá» JS, bÃ i viáº¿t nÃ y sáº½ giÃºp báº¡n hiá»ƒu táº¡i sao JS láº¡i khÃ¡ &quot;kÃ¬ cá»¥c&quot; so vá»›i cÃ¡c ngÃ´n ngá»¯ khÃ¡c.</p>
<p>CÃ²n náº¿u báº¡n lÃ  má»™t Ä‘á»“ng Ä‘áº¡o Ä‘Ã£ tráº£i qua nhiá»u Ä‘au thÆ°Æ¡ng vá»›i JS, thÃ¬ mÃ¬nh hi vá»ng ráº±ng, nhá»¯ng chia sáº» dÆ°á»›i Ä‘Ã¢y sáº½ cho báº¡n má»™t cÃ¡i nhÃ¬n sÃ¢u hÆ¡n vá» JS Runtime. Äá»ƒ tá»‘i Æ°u code báº¡n Ä‘Ã£ tá»«ng viáº¿t ra hay code cá»§a team member nÃ o Ä‘Ã³ mÃ  báº¡n ghÃ©t.</p>
<h2 id="javascript-engine">JavaScript Engine</h2>
<p>Tá»« khi NodeJS ra máº¯t nÄƒm 2009, cÃ¡i tÃªn V8 Ä‘Ã£ trá»Ÿ nÃªn ráº¥t phá»• biáº¿n. Äá»“ng thá»i cÅ©ng trá»Ÿ thÃ nh vÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh cho má»™t JS Engine.</p>
<p>V8 JS Engine bao gá»“m hai thÃ nh pháº§n chÃ­nh:</p>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/v8-engine.png" alt="V8 JS Engine" title="V8 JS Engine"></p>
<ul>
<li>Memory Heap: cáº¥p phÃ¡t bá»™ nhá»› sáº½ diá»…n ra á»Ÿ Ä‘Ã¢y.</li>
<li>Call Stack: cáº¥u trÃºc dá»¯ liá»‡u nÆ¡i chá»©a cÃ¡c lá»i gá»i hÃ m khi code Ä‘Æ°á»£c thá»±c thi.</li>
</ul>
<h2 id="call-stack">Call Stack</h2>
<p>JavaScript Ä‘Ã£ giá»›i thiá»‡u nÃ³ lÃ  má»™t ngÃ´n ngá»¯ Ä‘Æ¡n luá»“ng, cÅ©ng cÃ³ nghÄ©a lÃ  nÃ³ chá»‰ cÃ³ má»™t Call Stack vÃ  má»™t lÃºc chá»‰ lÃ m má»™t viá»‡c thÃ´i.</p>
<blockquote>
<p>Call Stack lÃ  má»™t cáº¥u trÃºc dá»¯ liá»‡u dáº¡ng ngÄƒn xáº¿p (stack) dÃ¹ng Ä‘á»ƒ chá»©a thÃ´ng tin vá» hoáº¡t Ä‘á»™ng cá»§a chÆ°Æ¡ng trÃ¬nh mÃ¡y tÃ­nh trong lÃºc thá»±c thi.</p>
<p>-- dá»‹ch tá»« <a href="https://en.wikipedia.org/wiki/Call_stack">Wiki</a></p>
</blockquote>
<p>Náº¿u báº¡n Ä‘Ã£ tá»«ng debug code kiá»ƒu nháº£y tá»«ng dÃ²ng lá»‡nh, thÆ°á»ng thÃ¬ cÃ¡c IDE sáº½ cung cáº¥p luÃ´n má»™t giao diá»‡n Ä‘á»ƒ chÃºng ta xem call stack hiá»‡n táº¡i. NÃ´m na lÃ  khi báº¡n debug/step Ä‘áº¿n má»™t function A, thÃ¬ A sáº½ Ä‘Æ°á»£c <code>push</code> (on top) vÃ o call stack. Sau khi A thá»±c thi xong vÃ  tráº£ vá» káº¿t quáº£, A sáº½ bá»‹ <code>pop</code> ra khá»i stack.</p>
<p>Call Stack cá»§a JS cÅ©ng váº­y thÃ´i. HÃ£y nhÃ¬n vÃ­ dá»¥ sinh Ä‘á»™ng trá»±c quan dÆ°á»›i Ä‘Ã¢y nhÃ©.</p>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/js-call-stack.gif" alt="JS Call Stack" title="JS Call Stack"></p>
<p>Call Stack ban Ä‘áº§u sáº½ trá»‘ng trÆ¡n khi engine báº¯t Ä‘áº§u thá»±c thi Ä‘oáº¡n code. Ngay sau Ä‘Ã³, tá»«ng step sáº½ giá»‘ng nhÆ° trÃªn. Má»—i step báº¡n tháº¥y trong hÃ¬nh lÃ  má»™t entry hay má»™t báº£n ghi trong Call Stack vÃ  Ä‘Æ°á»£c gá»i lÃ  <strong>Stack Frame</strong>.</p>
<p>CÃ¡i <strong>strack trace</strong> báº¡n trÃ´ng tháº¥y khi <code>console.log</code> má»™t exception cÅ©ng Ä‘Æ°á»£c xÃ¢y dá»±ng nhÆ° tháº¿.</p>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/js-stack-trace.png" alt="JS stack trace" title="JS stack trace"></p>
<p><strong>Stack overflow</strong> xáº£y ra khi chÆ°Æ¡ng trÃ¬nh vÆ°á»£t quÃ¡ kÃ­ch thÆ°á»›c tá»‘i Ä‘a cá»§a Call Stack. VÃ  nÃ³ ráº¥t dá»… xáº£y ra, Ä‘áº·c biá»‡t khi báº¡n hay ai Ä‘Ã³ trong team lá»¡ nghá»‹ch dáº¡i vá»›i Ä‘á»‡ quy:</p>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/stack-overflow.png" alt="Stack Overflow" title="Stack Overflow"></p>
<h2 id="javascript-runtime">JavaScript Runtime</h2>
<p>CÃ³ thá»ƒ báº¡n sáº½ báº¥t ngá» khi biáº¿t ráº±ng, sá»± tháº­t lÃ  cÃ¡c API nhÆ° <code>AJAX</code>, <code>setTimeout</code> hay <code>DOM</code> khÃ´ng náº±m trong JS Engine.</p>
<p><strong>JS Runtime</strong> lÃ  má»™t bá»©c tranh lá»›n vÃ  phá»©c táº¡p hÆ¡n chá»© khÃ´ng chá»‰ gÃ³i gá»n trong JS Engine. Trong pháº¡m vi bÃ i viáº¿t chÃºng ta sáº½ hiá»ƒu Ä‘áº§y Ä‘á»§ JS Runtime lÃ  <strong>browser&#39;s JS runtime environment</strong>. VÃ  nÃ³ bao gá»“m nhá»¯ng thÃ nh pháº§n sau Ä‘Ã¢y:</p>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/js-runtime-big-picture.png" alt="JS Runtime" title="JS Runtime"></p>
<p>ChÃºng ta táº¡m gá»i DOM, AJAX, setTimeout... Ä‘Æ°á»£c cung cáº¥p bá»Ÿi browser lÃ  <strong>Web APIs</strong>.</p>
<p>CÃ²n <strong>event loop</strong> vÃ  <strong>callback queue</strong> lÃ  gÃ¬? ChÃºng Ä‘Ã³ng vai trÃ² nhÆ° tháº¿ nÃ o trong JS Runtime? Má»i cÃ¡c báº¡n Ä‘á»c tiáº¿p pháº§n dÆ°á»›i.</p>
<h2 id="concurrency-v-event-loop-v-callback-queue">Concurrency vÃ  Event Loop vÃ  Callback queue</h2>
<h3 id="v-n-c-a-single-threaded">Váº¥n Ä‘á» cá»§a single-threaded</h3>
<p>NhÃ¬n chung, viáº¿t code Ä‘Æ¡n luá»“ng (single-threaded) thÆ°á»ng dá»… thá»Ÿ hÆ¡n khi báº¡n cháº£ cáº§n quan tÃ¢m tá»›i máº¥y váº¥n Ä‘á» nhá»©c Ä‘áº§u bÃªn láº­p trÃ¬nh Ä‘a luá»“ng (multi-threaded) nhÆ° lÃ  deadlock.</p>
<p>NhÆ°ng bÃ¹ láº¡i single-threaded cÅ©ng ráº¥t háº¡n cháº¿. NhÆ° Ä‘Ã£ nÃ³i á»Ÿ trÃªn, JS chá»‰ cÃ³ má»™t Call Stack, chuyá»‡n gÃ¬ sáº½ xáº£y ra khi báº¡n viáº¿t nhá»¯ng Ä‘oáº¡n code xá»­ lÃ½ cÃ¡c tÃ¡c vá»¥ náº·ng?</p>
<p>NhÆ° xá»­ lÃ½ áº£nh cháº³ng háº¡n.</p>
<pre><code class="lang-javascript">function resize() {
    console.log(&quot;starts resizing the image.. It may take 1 hour.&quot;);
    // user1: oops, okay lets wait
    // user2: or maybe I will go home and back on tomorrow
}
</code></pre>
<p>Khi hÃ m <code>resize()</code> Ä‘Æ°á»£c push vÃ o trong Call Stack vÃ  báº¯t Ä‘áº§u thá»±c thi, browser sáº½ bá»‹ block, vÃ  cÃ¡c tÃ¡c vá»¥ khÃ¡c ká»ƒ cáº£ <strong>render</strong> pháº£i chá» hÆ¡n tiáº¿ng Ä‘á»“ng há»“. ÄÃ¢y sáº½ lÃ  má»™t big problem vá»›i User Experience. CÆ¡ mÃ  thá»±c táº¿ thÃ¬ vá»›i cÃ¡c browser hiá»‡n Ä‘áº¡i, nhÆ° Chrome sáº½ show warning nÃ y lÃªn khi bá»‹ block (unresponsive) quÃ¡ lÃ¢u.</p>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/page_unresponsive.jpg" alt="Page Unresponsive" title="Page Unresponsive"></p>
<p>Váº­y lÃ m tháº¿ nÃ o bÃ¢y giá»?</p>
<p>BÃ¬nh tÄ©nh, Ä‘Ã¢y lÃ  lÃºc <strong>Asynchronous callbacks</strong> Ä‘áº¿n Ä‘á»ƒ giáº£i cá»©u. ChÃºng lÃ  cÃ¡c <strong>non-blocking</strong> function trong browser hay trong NodeJS vÃ  chÃºng sáº½ Ä‘Æ°á»£c cháº¡y báº¥t Ä‘á»“ng bá»™ vá»›i sá»± há»— trá»£ cá»§a Runtime environment.</p>
<h3 id="do-things-concurrently-by-using-async-callbacks">Do things concurrently by using Async Callbacks</h3>
<p>Äáº§u tiÃªn hÃ£y xem xÃ©t vÃ­ dá»¥ sau.</p>
<pre><code class="lang-javascript">function main() {
    console.log(&quot;Hi!&quot;);

    setTimeout(function timeout() {
        console.log(&quot;There!&quot;);
    }, 5000);

    console.log(&quot;Welcome to loupe!&quot;);
}
main();
</code></pre>
<p>Khi nhÃ¬n vÃ o Ä‘oáº¡n code trÃªn, ta cÃ³ thá»ƒ dá»… dÃ ng hiá»ƒu lÃ :</p>
<ul>
<li><code>console</code> sáº½ in &quot;Hi!&quot; ra Ä‘áº§u tiÃªn.</li>
<li><code>setTimeout</code> Ä‘Æ°á»£c gá»i vá»›i má»™t async callback lÃ  <code>timeout</code> chá»©a dÃ²ng lá»‡nh gá»i <code>console.log(&quot;There!&quot;)</code>.</li>
<li>NhÆ°ng ta sáº½ expect lÃ  browser khÃ´ng chá» 5s sau mÃ  in ra &quot;Welcome to loupe!&quot; ngay sau &quot;Hi!&quot;. Rá»“i sau Ä‘Ã³ má»™t tÃ­ thÃ¬ &quot;There!&quot; má»›i xuáº¥t hiá»‡n.</li>
<li>VÃ  thá»±c táº¿ Ä‘Ãºng lÃ  nhÆ° váº­y.</li>
</ul>
<p>Báº¡n hÃ£y quan sÃ¡t Call Stack trong quÃ¡ trÃ¬nh Ä‘oáº¡n code Ä‘Æ°á»£c cháº¡y.</p>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/async-in-call-stack.gif" alt="Async Callbacks &amp; The Call Stack" title="Async Callbacks &amp; The Call Stack"></p>
<p>Báº¡n cÃ³ tháº¯c máº¯c táº¡i sao hÃ m <code>main</code> cháº¡y xong vÃ  ra khá»i Call Stack rá»“i, mÃ  <code>timeout</code> vá»›i <code>console.log(&quot;There!&quot;)</code> láº¡i á»Ÿ Ä‘Ã¢u Ä‘Æ°á»£c Ä‘áº©y vÃ´ hay váº­y?</p>
<p>HÃ£y nhÃ¬n láº¡i bá»©c tranh bá»± á»Ÿ pháº§n Runtime, Ã½ mÃ¬nh lÃ  <strong>browser&#39;s JS runtime environment</strong>. BÃªn cáº¡nh JS Engine, browser cÃ²n cung cáº¥p cÃ¡c <strong>WebAPIs</strong>, má»™t <strong>event loop</strong> vÃ  má»™t <strong>callback queue</strong>. ChÃºng cháº¡y trÃªn cÃ¡c thread riÃªng vÃ  Ä‘Æ°á»£c browser báº£o trá»£ vá» concurrency.</p>
<p>HoÃ n toÃ n tÆ°Æ¡ng tá»± vá»›i NodeJS, thay vÃ¬ WebAPIs thÃ¬ Node&#39;s Runtime Environment sáº½ cung cáº¥p <strong>C++ APIs</strong> vÃ  cÃ¡c thá»© khÃ¡c nhÆ° event loop hay callback queue Ä‘Æ°á»£c implement báº±ng C++ á»Ÿ phÃ­a dÆ°á»›i (behind the scene).</p>
<p>Tiáº¿p theo mÃ¬nh sáº½ giáº£i thÃ­ch concurrency Ä‘Æ°á»£c thá»±c hiá»‡n nhÆ° tháº¿ nÃ o vá»›i hai thÃ nh pháº§n sau Ä‘Ã¢y.</p>
<h3 id="event-loop-v-callback-queue">Event Loop vÃ  Callback queue</h3>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/event-loop-and-callback-queue-in-action.gif" alt="Event loop and Callback Queue in action" title="Event loop and Callback Queue in action"></p>
<p>MÃ¬nh Ä‘Ã£ láº¥y láº¡i vÃ­ dá»¥ há»“i nÃ£y, nhÆ°ng thÃªm Event Loop (EL) vÃ  Callback Queue (CQ) vÃ o bá»©c tranh. CÃ¡c hÃ m async callback sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ ng Ä‘á»£i CQ. CÃ²n nhiá»‡m vá»¥ cá»§a EL lÃ  Ä‘á»£i cho Call Stack (CS) rá»—ng rá»“i sáº½ soi CQ xem cÃ³ gÃ¬ khÃ´ng, náº¿u cÃ³ thÃ¬ bá»‘c cÃ¡i Ä‘áº§u tiÃªn bá» vÃ o CS Ä‘á»ƒ cháº¡y.</p>
<p>Náº¿u báº¡n Ä‘á»ƒ Ã½ cÃ¡i gif trÃªn kÄ© chÃºt thÃ¬ sáº½ khÃ´ng tháº¥y <code>setTimeout</code> xuáº¥t hiá»‡n trong khung <strong>WebApis</strong>, thÃ¬ táº¡i chÃºng ta Ä‘ang Ä‘á»ƒ timeout=0 mÃ . Äiá»u nÃ y kháº³ng Ä‘á»‹nh láº¡i ráº±ng, EL pháº£i Ä‘á»£i cho CS rá»—ng thÃ¬ má»›i Ä‘áº©y tÃ¡c vá»¥ tá»« CQ vÃ o. NÃªn cho dÃ¹ báº¡n Ä‘á»ƒ <code>setTimeout</code> <em>zero</em> thÃ¬ <code>cantWait()</code> cÅ©ng pháº£i chá» vÃ  &quot;Zero there!&quot; sáº½ Ä‘Æ°á»£c in ra sau cÃ¹ng.</p>
<p>Yeah! Giá» má»—i khi muá»‘n trÃ¬ hoÃ£n má»™t tÃ¡c vá»¥ nÃ o Ä‘Ã³ cho Ä‘áº¿n khi CS rá»—ng thÃ¬ báº¡n chá»‰ viá»‡c <code>setTimeout(cb(), 0)</code>. LÆ°u láº¡i nhÃ©, rá»“i lÃºc nÃ o Ä‘Ã³ Ä‘em ra hÃ¹ máº¥y tháº±ng coder hay lÃ²e cÃ¡c á»©ng viÃªn mÃ  báº¡n interview ğŸ˜†.</p>
<p>CÃ³ thá»ƒ rÃºt ra thÃªm má»™t Ä‘iá»u ná»¯a vá» báº£n cháº¥t cá»§a <code>setTimeout</code>. NÃ³ khÃ´ng áº¥n Ä‘á»‹nh thá»i gian khi nÃ o tÃ¡c vá»¥ (callback truyá»n vÃ o) Ä‘Æ°á»£c thá»±c thi. NÃ³ chá»‰ Ä‘áº£m báº£o sau Ã­t nháº¥t <em>n</em> milliseconds thÃ¬ thá»±c thi tÃ¡c vá»¥ Ä‘Ã³, giá»‘ng nhÆ° vÃ­ dá»¥ <code>setTimeout zero</code> khÃ´ng cháº¡y <code>cantWait()</code> ngay láº­p tá»©c.</p>
<p>Táº¥t nhiÃªn ngoÃ i <code>setTimeout</code> thÃ¬ táº¥t cáº£ cÃ¡c API khÃ¡c Ä‘á»u hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± vá»›i async callback. VÃ­ dá»¥ khi gá»i má»™t AJAX request <code>myAjaxCall(cb())</code>, nÃ³ sáº½ cháº¡y trong cá»¥c <strong>WebAPIs</strong> thread riÃªng cá»§a browser chá»© khÃ´ng pháº£i JS Engine. NÃªn cho dÃ¹ AJAX call Ä‘Ã³ cÃ³ cháº¡y mÃ£i khÃ´ng xong, thÃ¬ cÃ¡c tÃ¡c vá»¥ khÃ¡c trong CS váº«n tiáº¿p tá»¥c Ä‘Æ°á»£c bá»‘c ra vÃ  thá»±c thi.<br>VÃ  khi <code>myAjaxCall</code> xong rá»“i, <code>cb</code> láº¡i Ä‘Æ°á»£c push vÃ o CQ, EL dÃ²m tháº¥y CS rá»—ng thÃ¬ bá»‘c bá» vÃ o.</p>
<p>Okay, that&#39;s it! Hi vá»ng báº¡n Ä‘Ã£ hiá»ƒu Event Loop lÃ  cÃ¡i quÃ¡i gÃ¬ rá»“i.</p>
<h3 id="ch-ch-t-th-c-callback-l-ch-y-async-">Chá» chÃºt, tháº¿ cá»© callback lÃ  cháº¡y async Ã ?</h3>
<pre><code class="lang-javascript">// Synchronous
[1,2,3,4].forEach(function(i) {
    console.log(i);
});

// Asynchronous
function asyncForeach(array, cb) {
    array.forEach(function() {
        setTimeout(cb, 0);
    });
}

asyncForEach([1,2,3,4], function(i) {
    console.log(i);
});
</code></pre>
<p>Okay, nÃ³i chung lÃ  tÃ¹y pháº¡m vi vÃ  tÃ¹y Ä‘á»‘i tÆ°á»£ng mÃ  vá»›i má»—i ngÆ°á»i thÃ¬ <strong>callback</strong> cÃ³ thá»ƒ lÃ :</p>
<ul>
<li>Báº¥t cá»© function nÃ o Ä‘Æ°á»£c truyá»n vÃ o vÃ  Ä‘Æ°á»£c gá»i trong má»™t function khÃ¡c.</li>
<li>Ãm chá»‰ <strong>async</strong> callback sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o CQ vÃ  chá» cho CS rá»—ng Ä‘á»ƒ thá»±c thi.</li>
</ul>
<p>Trong Ä‘oáº¡n code trÃªn, á»Ÿ pháº§n Ä‘áº§u tiÃªn, function báº¡n truyá»n vÃ o <code>forEach</code> cÅ©ng gá»i lÃ  callback nhÆ°ng nÃ³ sáº½ cháº¡y Ä‘á»“ng bá»™ (sync) trong CS chá»© khÃ´ng chá» ai cáº£. NgÆ°á»£c láº¡i <code>cb</code> trong <code>asyncForeach</code> lÃ  má»™t <strong>async</strong> callback vÃ  sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o CQ vÃ  pháº£i chá» cho Ä‘oáº¡n synchronous kia cháº¡y xong, CS rá»—ng rá»“i EL sáº½ bá»‘c cÃ¡c <code>cb</code> trong CQ ra Ä‘á»ƒ cháº¡y.</p>
<p>MÃ¬nh nhÃ¡c táº¡o <code>gif</code> quÃ¡, máº¥y báº¡n <a href="http://latentflip.com/loupe/">vÃ´ Ä‘Ã¢y</a> Ä‘á»ƒ visualize vÃ­ dá»¥ trÃªn nhÃ©.</p>
<h3 id="ch-a-h-t-c-n-n-a-">ChÆ°a háº¿t, cÃ²n ná»¯a!</h3>
<p>UI Ä‘Æ°á»£c browser render má»™t cÃ¡ch mÆ°á»£t mÃ  nháº¥t vá»›i con sá»‘ lÃ½ tÆ°á»Ÿng lÃ  60 fps (nhÆ° game váº­y), tá»©c lÃ  cá»© khoáº£ng 16.6ms thÃ¬ váº½ láº¡i mÃ n hÃ¬nh má»™t láº§n. NhÆ°ng thá»±c táº¿ vÃ¬ nhiá»u nguyÃªn nhÃ¢n khÃ¡c nhau, render bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi viá»‡c cháº¡y code JavaScript.</p>
<p>Browser khÃ´ng thá»ƒ gá»i <code>render()</code> náº¿u cÃ³ code JS cáº§n cháº¡y trong CS. Kiá»ƒu nhÆ° tá»± nÃ³ lÃ  async callback váº­y, pháº£i Ä‘á»£i cho CS rá»—ng má»›i cháº¡y Ä‘Æ°á»£c. Chá»‰ khÃ¡c má»™t chÃºt lÃ  <code>render()</code> Ä‘Æ°á»£c Æ°u tiÃªn hÆ¡n so vá»›i cÃ¡c callback thÃ´ng thÆ°á»ng. Cá»© má»—i 16ms, má»™t lá»i gá»i <code>render()</code> sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o hÃ ng Ä‘á»£i vÃ  Ä‘áº¿n khi CS rá»—ng thÃ¬ má»›i Ä‘Æ°á»£c thá»±c thi.</p>
<p>NÃªn náº¿u báº¡n block CS quÃ¡ lÃ¢u thÃ¬ UI sáº½ bá»‹ Ä‘Æ¡, user cháº³ng thá»ƒ click lÃªn button hay edit text Ä‘Æ°á»£c ná»¯a. Rá»“i má»™t lÃºc sau browser sáº½ hiá»‡n warning <a href="#v-n-c-a-single-threaded">nhÆ° trÃªn kia</a>. BÃ¹m! máº¥t Ä‘iá»ƒm hoáº·c tháº­m chÃ­ máº¥t luÃ´n user.</p>
<p>Äiá»u nÃ y cÃ²n cÃ³ thá»ƒ Ã¡p dá»¥ng cho cÃ¡c platform khÃ¡c nhÆ° Windows, Android, iOS... VÃ¬ thá»±c táº¿ má»i Graphic hay UI Engine Ä‘á»u cháº¡y single thread. Ta khÃ´ng nÃªn cháº¡y business code trÃªn UI Thread náº¿u khÃ´ng muá»‘n bá»‹ nhÆ° sau.</p>
<p><img src="/p/javascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop/img/ui-not-responding.png" alt="Windows GUI not responding" title="UI not responding"></p>
<p><em>Okay, váº­y tÃ´i chá»‰ cáº§n xÃ i async callback lÃ  Ä‘Æ°á»£c chá»© gÃ¬!?</em></p>
<p>HÃ£y suy nghÄ© kÄ© láº¡i nhá»¯ng gÃ¬ chÃºng ta tÃ¬m hiá»ƒu nÃ£y giá». Async Callback thá»±c táº¿ rá»“i cÅ©ng sáº½ Ä‘Æ°a vÃ o CS vÃ  cháº¡y, vÃ  nÃ³ hoÃ n toÃ n cÃ³ thá»ƒ block UI náº¿u báº¡n khÃ´ng cáº©n tháº­n, Ä‘áº·c biá»‡t lÃ  khi xá»­ lÃ½ áº£nh hay lÃ m animation.</p>
<p>Má»™t vÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh lÃ  <code>scroll handler</code>.</p>
<pre><code class="lang-javascript">function animateSomething() {
    // something slow
}

window.addEventListener(&#39;scroll&#39;, animateSomething);
</code></pre>
<p>SiÃªu Ä‘iá»ƒn hÃ¬nh luÃ´n, mÃ¬nh Ä‘Ã£ tá»«ng bá»‹ nhiá»u láº§n rá»“i. CÃ¡i <code>scroll</code> event nÃ y Ä‘Æ°á»£c trigger cá»±c nhiá»u, theo mÃ¬nh (vÃ  cáº£ anh Philip Roberts) thÃ¬ trigger má»—i frame hay 16ms. NÃªn náº¿u khÃ´ng xá»­ lÃ½ cáº©n tháº­n thÃ¬ UI sáº½ giáº­t tung cháº£o hoáº·c Ä‘Æ¡ luÃ´n.</p>
<h2 id="l-i-k-t">Lá»i káº¿t</h2>
<p>DÃ¹ Ä‘Ã£ cÃ³ ráº¥t nhiá»u video vÃ  blog cÃ¹ng topic, nhÆ°ng mÃ¬nh hi vá»ng lÃ  sau bÃ i viáº¿t nÃ y, báº¡n cÃ³ thÃªm vÃ i Ã½ tÆ°á»Ÿng Ä‘á»ƒ optimize code cá»§a mÃ¬nh vÃ  cá»§a team.</p>
<p>HÆ¡n ná»¯a, giá»¯a nhá»¯ng rá»«ng framework hay lib má»—i ngÃ y ra vÃ i trÄƒm cÃ¡i, ta nÃªn dá»«ng láº¡i má»™t chÃºt vÃ  tÃ¬m vá» thá»i nguyÃªn thá»§y (chá»© giá» cÃ³ Promise, async/await rá»“i) Ä‘á»ƒ hiá»ƒu JS hÆ¡n nhá»¯ng lÃºc than thá»Ÿ &quot;I hate JavaScript!&quot; ğŸ˜†.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://blog.sessionstack.com/how-does-javascript-actually-work-part-1-b0bacc073cf">How JavaScript actually work</a></li>
<li><a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ">Philip Roberts: What the heck is Event Loop anyway?</a></li>
<li><a href="http://latentflip.com/loupe/">Loupe: a tool to visualize the JavaScript Runtime at Runtime</a></li>
<li><a href="https://blog.sessionstack.com/how-javascript-works-inside-the-v8-engine-5-tips-on-how-to-write-optimized-code-ac089e62b12e">5 tips on how to write optimized JS code</a></li>
<li><a href="https://kipalog.com/posts/Event-driven-trong-Node-js">https://kipalog.com/posts/Event-driven-trong-Node-js</a></li>
<li><a href="https://www.quora.com/What-is-the-difference-between-javascript-engine-and-javascript-runtime">https://www.quora.com/What-is-the-difference-between-javascript-engine-and-javascript-runtime</a></li>
</ul>
</section><section class="copyright">CÃ³ lÃ²ng thÃ¬ cho mÃ¬nh xin Ã­t like rá»“i thÃ­ch share hay post láº¡i gÃ¬ cÅ©ng Ä‘Æ°á»£c.<strong> CÆ¡ mÃ </strong> pháº£i <strong>ghi rÃµ nguá»“n, tÃ¡c giáº£ vÃ  khÃ´ng lÃ m thay Ä‘á»•i ná»™i dung bÃ i viáº¿t</strong>. &quot;á»¨ lÃ m theo Ä‘áº¥y rá»“i sao!&quot;. á»œ thÃ¬ cÅ©ng Ä‘Æ°á»£c thÃ´i, sau nÃ y trÃªn Ä‘Æ°á»ng Ä‘á»i táº¥p náº­p, nhá»¡ cÃ³ va vÃ o nhau thÃ¬ cho mÃ¬nh ná»‡n cá»¥c gáº¡ch!!!<i id="brick"></i> ChÃ o thÃ¢n Ã¡i vÃ  quyáº¿t tháº¯ng!</section><section class="likebox"><iframe class="fb-like" src="https://www.facebook.com/plugins/like.php?href=https%3A%2F%2Fblogchanhday.com%2Fp%2Fjavascript-tong-quan-ve-engine-runtime-call-stack-va-event-loop%2Findex.html&amp;layout=standard&amp;action=like&amp;size=small&amp;show_faces=true&amp;share=true&amp;colorscheme=light&amp;appId=1451967558408105" title="Facebook like box" height="56" width="450" style="border:none;overflow:hidden" scrolling="no" frameBorder="0" allowtransparency="true" allow="encrypted-media"></iframe></section><section class="comments"><div id="login-box" class="login" style="display:none">Báº¡n cáº§n <button>Login</button> Ä‘á»ƒ comment</div><div id="comment-box" class="comment-input" style="display:none"><div class="avatar"><img id="user-avatar" src="" width="32" height="32" alt="avatar"/></div><div class="input"><textarea id="comment-content" placeholder="Báº¡n nghÄ© gÃ¬ vá» bÃ i viáº¿t nÃ y?"></textarea><span>GÃµ xong nháº¥n <kbd>Ctrl</kbd> + <kbd>Enter</kbd> Ä‘á»ƒ gá»­i.</span></div></div><div><div id="comment-loading" class="loading" style="display:block"></div><ul id="comment-list" class="comment-list"></ul></div></section><button id="go-top" title="Go to top"><i class="icon-up-open"></i></button></article></main><footer><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"/></a><p>Created with <a href="https://github.com/johnlemon93/blog-page-ssr">Blog Page SSR</a></p><div class="social"><a target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/blogchanhday"><i class="icon-facebook-squared"></i></a><a target="_blank" rel="noopener noreferrer" href="https://github.com/johnlemon93"><i class="icon-github-squared"></i></a><a target="_blank" rel="noopener noreferrer" href="https://blogchanhday.com"><i class="icon-emo-coffee"></i></a></div></footer></div><script type="text/javascript" src="/static/js/main.432ca91a.js"></script><script type="text/javascript" src="/static/js/postChunk.73143019.chunk.js"></script></body></html>